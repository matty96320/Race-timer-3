<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enduro Race Sign-up</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
body {
font-family: 'Inter', sans-serif;
background-color: #f3f4f6;
color: #374151;
}
.container {
max-width: 900px;
}
.card {
background-color: #ffffff;
border-radius: 12px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
border: 1px solid #e5e7eb;
padding: 2rem;
}
.button {
transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
}
.button:hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
.header-bg {
background: linear-gradient(to right, #1d4ed8, #4f46e5);
}
table {
border-collapse: separate;
border-spacing: 0;
}
th, td {
padding: 0.75rem 1rem;
text-align: left;
border-bottom: 1px solid #e5e7eb;
}
tbody tr:last-child td { border-bottom: none; }
th:first-child, td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
th:last-child, td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
thead th {
background-color: #f9fafb;
color: #4b5563;
font-weight: 600;
text-transform: uppercase;
font-size: 0.75rem;
letter-spacing: 0.05em;
}
tbody tr:nth-child(even) { background-color: #f9fafb; }

/* Tab styling */
.tab-button {
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease-in-out;
border: 2px solid transparent;
}
.tab-button.active {
background-color: #ffffff;
color: #4f46e5;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.tab-button:not(.active) {
color: #6b7280;
}
.tab-button:not(.active):hover {
background-color: #f0f0f5;
}
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Instances ---
let app, db, auth;

// --- Global State ---
let raceData = { riders: [], stages: 0, seedingCategories: [], resultsCategories: [] }; 
let raceUnsubscribe = null;
let userId = null, currentRaceId = null, appId = 'enduro-timer-default';
const MAX_RIDERS = 250; 

// --- DOM Elements ---
let raceSearchDiv, raceIdInput, findRaceBtn;
let racePortalDiv, raceNameDisplay, raceIdDisplay, riderCountDisplay;
let signUpForm, resultsTableBody, messageBox;
let tabButtons, tabContents; 
let riderCategorySelect; // This is for SEEDING
// --- MODIFICATION: Added new variable for results category dropdown ---
let riderResultsCategorySelect; 
let publicMessageDisplay;

const showMessage = (message, isError = false) => {
if (!messageBox) return;
messageBox.textContent = message;
messageBox.className = `p-3 rounded-md text-center font-semibold mb-4 transition-all duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
messageBox.classList.remove('opacity-0', 'scale-95');
messageBox.classList.add('opacity-100', 'scale-100');
setTimeout(() => {
messageBox.classList.remove('opacity-100', 'scale-100');
messageBox.classList.add('opacity-0', 'scale-95');
}, 4000); 
};

const formatTime = (seconds) => {
if (seconds === 'DNF') return 'DNF';
if (seconds === null || typeof seconds !== 'number') return 'N/A';
const h = Math.floor(seconds / 3600);
const m = Math.floor((seconds % 3600) / 60);
const s = Math.floor(seconds % 60);
const format = (val) => val.toString().padStart(2, '0');
return `${format(h)}:${format(m)}:${format(s)}`;
};

const getProvisionalData = (rider) => {
const completedTimes = rider.times.filter(t => typeof t === 'number');
return { stagesCompleted: completedTimes.length, provisionalTime: completedTimes.reduce((a, b) => a + b, 0) };
};

const setupTabs = () => {
tabButtons = document.querySelectorAll('.tab-button');
tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
button.addEventListener('click', () => {
tabButtons.forEach(btn => btn.classList.remove('active'));
button.classList.add('active');

tabContents.forEach(content => content.classList.add('hidden'));
const tabId = button.dataset.tab;
if(tabId) {
const contentEl = document.getElementById(tabId);
if (contentEl) contentEl.classList.remove('hidden');
}
});
});
if(tabButtons.length > 0) tabButtons[0].click();
};

const populateSeedingCategoryDropdown = () => {
if (!riderCategorySelect) return;
riderCategorySelect.innerHTML = '<option value="">-- No Category --</option>';
if (raceData.seedingCategories) {
raceData.seedingCategories.forEach(category => {
const option = document.createElement('option');
option.value = category;
option.textContent = category;
riderCategorySelect.appendChild(option);
});
}
};

// --- NEW: Populate Public Results Category Dropdown ---
const populateResultsCategoryDropdown = () => {
if (!riderResultsCategorySelect) return;
riderResultsCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
if (raceData.resultsCategories) {
raceData.resultsCategories.forEach(category => {
const option = document.createElement('option');
option.value = category;
option.textContent = category;
riderResultsCategorySelect.appendChild(option);
});
}
};

const setupResultsListener = (raceId) => {
if (raceUnsubscribe) raceUnsubscribe();
currentRaceId = raceId;
const raceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', raceId);

raceUnsubscribe = onSnapshot(raceDocRef, (docSnap) => {
if (docSnap.exists()) {
raceData = docSnap.data();
if (!raceData.seedingCategories) raceData.seedingCategories = [];
if (!raceData.resultsCategories) raceData.resultsCategories = []; 

raceNameDisplay.textContent = raceData.raceName || 'Race';
raceIdDisplay.textContent = `Race ID: ${raceId}`;
riderCountDisplay.textContent = `Riders: ${raceData.riders.length}/${MAX_RIDERS}`; 
renderResults();
populateSeedingCategoryDropdown(); 
// --- MODIFICATION: Call new populate function ---
populateResultsCategoryDropdown(); 

if (publicMessageDisplay && raceData.raceMessage && raceData.raceMessage.trim() !== '') {
publicMessageDisplay.textContent = raceData.raceMessage;
publicMessageDisplay.classList.remove('hidden');
publicMessageDisplay.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
} else if (publicMessageDisplay) {
publicMessageDisplay.classList.add('hidden');
publicMessageDisplay.textContent = '';
}

} else {
showMessage('The race you were viewing seems to have been deleted.', true);
showSearch();
}
}, (error) => {
console.error("Error listening for results: ", error);
showMessage('Lost connection to race results.', true);
});
};

const renderResults = () => {
