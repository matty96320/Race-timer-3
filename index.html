<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enduro Race Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .button {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .stage-input-cell input {
            width: 100%;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .header-bg {
            background: linear-gradient(to right, #4c51bf, #6b46c1);
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
        }
        th:first-child, td:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        th:last-child, td:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        thead th {
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody tr {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        tbody tr:last-child {
            border-bottom: none;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Instances (declared here, initialized later) ---
        let app, db, auth;

        // --- Global State ---
        let raceData = {
            riders: [],
            stages: 6
        };
        let authReady = false;
        let raceUnsubscribe = null;
        let timersUnsubscribe = null;
        let userId = null;
        let currentRaceId = null;
        let activeTimers = {};
        let currentTimingStage = null;
        
        // --- DOM Elements ---
        let raceIdInput, loadRaceBtn, newRaceBtn, raceInfoDiv, raceTimerContainer;
        let riderForm, ridersTableBody, resultsTableBody, riderCountDisplay;
        let startTimerBtn, timingRiderInput, messageBox, activeTimersList, stageCountInput, exportCsvBtn;
        let stageSelectionContainer, timingStationSelect, startTimingStationBtn, timingStationActive, timingStationHeader, switchStageBtn;
        let stageStandingsHeader, stageStandingsBody, currentOverallStandingsBody;


        const showMessage = (message, isError = false) => {
            if (!messageBox) return;
            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-md text-center font-semibold mb-4 transition-all duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            messageBox.classList.remove('opacity-0', 'scale-95');
            messageBox.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'scale-100');
                messageBox.classList.add('opacity-0', 'scale-95');
            }, 3000);
        };

        const setupRaceListener = (raceId) => {
            if (raceUnsubscribe) raceUnsubscribe();
            currentRaceId = raceId;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
            const raceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', raceId);
            raceUnsubscribe = onSnapshot(raceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    raceData = docSnap.data();
                    if(currentTimingStage === null) {
                       showStageSelection();
                    }
                    renderRaceData();
                    populateTimingDropdown();
                } else {
                    console.log("No such document! Creating a new one.");
                    raceData = {
                        riders: [],
                        stages: raceData.stages,
                        raceId: raceId
                    };
                    setDoc(raceDocRef, raceData);
                }
            }, (error) => console.error("Error listening for real-time updates: ", error));
            setupTimersListener(raceId);
        };
        
        const setupTimersListener = (raceId) => {
            if (timersUnsubscribe) timersUnsubscribe();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
            const timersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'races', raceId, 'timers');
            timersUnsubscribe = onSnapshot(timersCollectionRef, (querySnapshot) => {
                activeTimers = {};
                querySnapshot.forEach((doc) => {
                    activeTimers[doc.id] = { ...doc.data(), id: doc.id };
                });
                renderActiveTimers();
            }, (error) => console.error("Error listening for active timers: ", error));
        };

        const renderActiveTimers = () => {
            if (!activeTimersList || currentTimingStage === null) return;
            activeTimersList.innerHTML = '';
            
            const stageTimers = Object.values(activeTimers).filter(timer => timer.stageIndex === currentTimingStage);

            if (stageTimers.length === 0) {
                activeTimersList.innerHTML = `<li class="text-sm text-gray-500">No active timers for this stage.</li>`;
            } else {
                stageTimers.forEach(timer => {
                    const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
                    const timeString = formatTime(elapsed);
                    
                    const rider = raceData.riders.find(r => r.number === timer.riderNumber);
                    const riderDetails = rider ? `(${rider.name}${rider.category ? ', ' + rider.category : ''})` : '';

                    const listItem = document.createElement('li');
                    listItem.className = "flex justify-between items-center p-2 bg-gray-100 rounded-md shadow-sm";
                    
                    const textNode = document.createElement('span');
                    textNode.textContent = `Rider #${timer.riderNumber} ${riderDetails} : ${timeString}`;
                    
                    const stopButton = document.createElement('button');
                    stopButton.textContent = 'Stop';
                    stopButton.className = 'button px-3 py-1 bg-red-600 text-white text-sm font-bold rounded-md shadow-sm hover:bg-red-700';
                    
                    stopButton.onclick = () => stopSpecificTimer(timer.riderNumber, timer.stageIndex);

                    listItem.appendChild(textNode);
                    listItem.appendChild(stopButton);
                    activeTimersList.appendChild(listItem);
                });
            }
        };

        const stopSpecificTimer = async (riderNumber, stageIndex) => {
            const timerDocId = `${riderNumber}-${stageIndex}`;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
            const timerDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', currentRaceId, 'timers', timerDocId);

            try {
                const docSnap = await getDoc(timerDocRef);
                if (docSnap.exists()) {
                    const timerData = docSnap.data();
                    const elapsedSeconds = Math.floor((Date.now() - timerData.startTime) / 1000);
                    await updateTime(riderNumber, timerData.stageIndex, elapsedSeconds);
                    showMessage(`Time saved for Rider #${riderNumber}, Stage ${timerData.stageIndex + 1}`);
                }
            } catch (error) {
                console.error("Error stopping timer: ", error);
                showMessage('Failed to stop timer.', true);
            } finally {
                await deleteDoc(timerDocRef);
            }
        };

        const populateTimingDropdown = () => {
            if (!timingRiderInput) return;
            const currentSelection = timingRiderInput.value;
            timingRiderInput.innerHTML = '<option value="">Select Rider to Start</option>';
            raceData.riders.forEach(rider => {
                const option = document.createElement('option');
                option.value = rider.number;
                const categoryText = rider.category ? ` (${rider.category})` : '';
                option.textContent = `${rider.number} - ${rider.name}${categoryText}`;
                timingRiderInput.appendChild(option);
            });
            timingRiderInput.value = currentSelection;
        };

        const loadRace = () => {
            const raceId = raceIdInput.value.trim();
            if (!raceId) {
                showMessage('Please enter a race ID.', true);
                return;
            }
            raceInfoDiv.classList.add('hidden');
            raceTimerContainer.classList.remove('hidden');
            document.getElementById('currentRaceIdDisplay').textContent = `Race ID: ${raceId}`;
            setupRaceListener(raceId);
        };

        const createNewRace = () => {
            const stages = parseInt(stageCountInput.value, 10);
            if (isNaN(stages) || stages <= 0) {
                showMessage('Please enter a valid number of stages.', true);
                return;
            }
            const newRaceId = `race_${Date.now()}`;
            raceData.stages = stages;
            raceIdInput.value = newRaceId;
            loadRace();
        };

        const addRider = async (event) => {
            event.preventDefault();
            if (!currentRaceId) return showMessage('Please create or load a race first.', true);

            const riderNumber = parseInt(document.getElementById('riderNumber').value, 10);
            const riderName = document.getElementById('riderName').value.trim();
            const riderCategory = document.getElementById('riderCategory').value.trim();

            if (raceData.riders.length >= 100) return showMessage('Maximum 100 riders.', true);
            if (!riderNumber || !riderName) return showMessage('Please enter both rider number and name.', true);
            if (raceData.riders.some(r => r.number === riderNumber)) return showMessage('Rider number already exists.', true);
            
            const newRider = {
                number: riderNumber,
                name: riderName,
                category: riderCategory,
                times: Array(raceData.stages).fill(null),
                totalTime: null,
                status: 'active'
            };

            const updatedRiders = [...raceData.riders, newRider];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
            const raceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', currentRaceId);
            await updateDoc(raceDocRef, { riders: updatedRiders });
            
            riderForm.reset();
            showMessage('Rider added successfully!');
        };
        
        const setRiderDnf = async (riderNumber, stageIndexToClear) => {
            const riderIndex = raceData.riders.findIndex(r => r.number === riderNumber);
            if (riderIndex !== -1) {
                let updatedRiders = JSON.parse(JSON.stringify(raceData.riders));
                updatedRiders[riderIndex].status = 'DNF';
                updatedRiders[riderIndex].totalTime = null; 
                if (typeof stageIndexToClear === 'number') {
                    updatedRiders[riderIndex].times[stageIndexToClear] = null;
                }
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
                const raceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', currentRaceId);
                await updateDoc(raceDocRef, { riders: updatedRiders });
                showMessage(`Rider #${riderNumber} marked as DNF.`);
            }
        };

        const updateTime = async (riderNumber, stageIndex, seconds) => {
            const riderIndex = raceData.riders.findIndex(r => r.number === riderNumber);
            if (riderIndex !== -1) {
                let updatedRiders = JSON.parse(JSON.stringify(raceData.riders));
                
                updatedRiders[riderIndex].times[stageIndex] = seconds;
                
                if(updatedRiders[riderIndex].status === 'DNF'){
                    updatedRiders[riderIndex].status = 'active';
                }

                const allStagesCompleted = updatedRiders[riderIndex].times.every(time => typeof time === 'number');

                if (allStagesCompleted) {
                    const total = updatedRiders[riderIndex].times.reduce((sum, time) => sum + (time || 0), 0);
                    updatedRiders[riderIndex].totalTime = total;
                } else {
                    updatedRiders[riderIndex].totalTime = null;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
                const raceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', currentRaceId);
                await updateDoc(raceDocRef, { riders: updatedRiders });
            }
        };

        const parseTimeToSeconds = (timeString) => {
            if (!timeString) return null;
            const parts = timeString.split(':').map(Number);
            if (parts.some(isNaN)) return null;
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            if (parts.length === 1) return parts[0];
            return null;
        };

        const formatTime = (seconds) => {
            if (seconds === null || typeof seconds !== 'number') return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const format = (val) => val.toString().padStart(2, '0');
            return `${format(h)}:${format(m)}:${format(s)}`;
        };

        const renderRaceData = () => {
            if (!ridersTableBody || !resultsTableBody) return;
            ridersTableBody.innerHTML = '';
            resultsTableBody.innerHTML = '';
            
            // --- Logic for Category Rankings ---
            const categories = [...new Set(raceData.riders.map(r => r.category).filter(c => c))];
            const categoryRankings = {};
            categories.forEach(cat => {
                categoryRankings[cat] = raceData.riders
                    .filter(r => r.category === cat && r.totalTime !== null && r.status !== 'DNF')
                    .sort((a, b) => a.totalTime - b.totalTime);
            });

            // --- Render Main Rider & Stage Times Table ---
            raceData.riders.forEach((rider) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-2 font-bold text-gray-700">${rider.number}</td>
                    <td class="px-4 py-2 text-gray-600">${rider.name}</td>
                    <td class="px-4 py-2 text-gray-500">${rider.category || ''}</td>
                `;
                
                for (let i = 0; i < raceData.stages; i++) {
                    const timeCell = document.createElement('td');
                    timeCell.className = 'px-4 py-2 text-gray-800 cursor-pointer hover:bg-yellow-200';
                    
                    if (rider.status === 'DNF' && rider.times[i] === null) {
                        timeCell.textContent = 'DNF';
                        timeCell.classList.add('text-red-600');
                    } else {
                        timeCell.textContent = formatTime(rider.times[i]);
                    }

                    timeCell.addEventListener('click', () => {
                        const newTimeStr = prompt(`Enter new time for ${rider.name} - Stage ${i + 1} (e.g., 5:30 or DNF):`, rider.status === 'DNF' ? 'DNF' : formatTime(rider.times[i]));
                        if (newTimeStr !== null) {
                            if (newTimeStr.trim().toUpperCase() === 'DNF') {
                                setRiderDnf(rider.number, i);
                            } else {
                                const newTimeInSeconds = parseTimeToSeconds(newTimeStr);
                                if (newTimeInSeconds !== null) {
                                    updateTime(rider.number, i, newTimeInSeconds);
                                } else if (newTimeStr.trim() === '' || newTimeStr.toLowerCase() === 'n/a') {
                                    updateTime(rider.number, i, null);
                                } else {
                                    showMessage('Invalid format. Enter time (e.g., 5:30) or DNF.', true);
                                }
                            }
                        }
                    });
                    row.appendChild(timeCell);
                }
                
                const totalCell = document.createElement('td');
                totalCell.className = 'px-4 py-2 font-semibold text-gray-800';
                totalCell.textContent = rider.status === 'DNF' ? 'DNF' : formatTime(rider.totalTime);
                row.appendChild(totalCell);
                
                ridersTableBody.appendChild(row);
            });
            
            // --- Logic for Main Overall Standings ---
            const finishedRiders = [...raceData.riders]
                .filter(rider => rider.totalTime !== null && rider.status !== 'DNF')
                .sort((a, b) => a.totalTime - b.totalTime);
            const incompleteRiders = raceData.riders.filter(rider => rider.totalTime === null && rider.status !== 'DNF');
            const dnfRiders = raceData.riders.filter(rider => rider.status === 'DNF');
            const allRidersRanked = [...finishedRiders, ...incompleteRiders, ...dnfRiders];

            // --- Render Main "Current Standings" Table ---
            allRidersRanked.forEach((rider) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rank, totalTimeDisplay, categoryRank = 'N/A';

                if (rider.status === 'DNF') {
                    rank = 'DNF';
                    totalTimeDisplay = 'DNF';
                    row.classList.add('text-red-600', 'opacity-75');
                } else if (rider.totalTime !== null) {
                    rank = finishedRiders.findIndex(r => r.number === rider.number) + 1;
                    totalTimeDisplay = formatTime(rider.totalTime);
                    if (rider.category && categoryRankings[rider.category]) {
                        const rankIndex = categoryRankings[rider.category].findIndex(r => r.number === rider.number);
                        if(rankIndex !== -1) categoryRank = rankIndex + 1;
                    }
                } else {
                    rank = 'N/A';
                    totalTimeDisplay = 'N/A';
                }

                row.innerHTML = `
                    <td class="px-4 py-2 text-center font-bold text-lg">${rank}</td>
                    <td class="px-4 py-2 text-center font-semibold text-md">${categoryRank}</td>
                    <td class="px-4 py-2">${rider.number}</td>
                    <td class="px-4 py-2">${rider.name}</td>
                    <td class="px-4 py-2 text-gray-500">${rider.category || ''}</td>
                    <td class="px-4 py-2 font-semibold">${totalTimeDisplay}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            riderCountDisplay.textContent = `Riders: ${raceData.riders.length}/100`;
            renderStageHeaders();
            renderStageSpecificResults(allRidersRanked, categoryRankings);
        };

        const renderStageHeaders = () => {
            const ridersTableHeader = ridersTableBody.parentNode.querySelector('thead tr');
            ridersTableHeader.innerHTML = `
                <th class="px-4 py-3">Rider #</th>
                <th class="px-4 py-3">Name</th>
                <th class="px-4 py-3">Category</th>
                ${Array.from({ length: raceData.stages }, (_, i) => `<th class="px-4 py-3">Stage ${i + 1}</th>`).join('')}
                <th class="px-4 py-3">Total Time</th>
            `;
        };
        
        const renderStageSpecificResults = (allRidersRanked, categoryRankings) => {
            if (currentTimingStage === null || !stageStandingsBody || !currentOverallStandingsBody) return;
            
            stageStandingsBody.innerHTML = '';
            currentOverallStandingsBody.innerHTML = '';

            // --- Render Stage-Specific Standings ---
            const stageIndex = currentTimingStage;
            const ridersWithStageTime = raceData.riders
                .filter(r => typeof r.times[stageIndex] === 'number' && r.status !== 'DNF')
                .sort((a, b) => a.times[stageIndex] - b.times[stageIndex]);
            
            const otherRiders = raceData.riders.filter(r => typeof r.times[stageIndex] !== 'number' || r.status === 'DNF');

            [...ridersWithStageTime, ...otherRiders].forEach((rider, index) => {
                 const row = document.createElement('tr');
                 const rank = (index < ridersWithStageTime.length) ? index + 1 : 'N/A';
                 const time = formatTime(rider.times[stageIndex]);
                 
                 if(rider.status === 'DNF') row.classList.add('text-red-600', 'opacity-75');

                 row.innerHTML = `
                    <td class="px-2 py-2 text-center font-bold">${rank}</td>
                    <td class="px-2 py-2">${rider.number}</td>
                    <td class="px-2 py-2">${rider.name}</td>
                    <td class="px-2 py-2 font-semibold">${rider.status === 'DNF' ? 'DNF' : time}</td>
                 `;
                 stageStandingsBody.appendChild(row);
            });


            // --- Render Current Overall Standings (on stage page) ---
            const finishedRiders = allRidersRanked.filter(r => r.totalTime !== null && r.status !== 'DNF');
            allRidersRanked.forEach(rider => {
                 const row = document.createElement('tr');
                 let rank, totalTimeDisplay, categoryRank = 'N/A';

                 if (rider.status === 'DNF') {
                    rank = 'DNF';
                    totalTimeDisplay = 'DNF';
                    row.classList.add('text-red-600', 'opacity-75');
                 } else if (rider.totalTime !== null) {
                    rank = finishedRiders.findIndex(r => r.number === rider.number) + 1;
                    totalTimeDisplay = formatTime(rider.totalTime);
                    if (rider.category && categoryRankings[rider.category]) {
                        const rankIndex = categoryRankings[rider.category].findIndex(r => r.number === rider.number);
                        if (rankIndex !== -1) categoryRank = rankIndex + 1;
                    }
                 } else {
                    rank = 'N/A';
                    totalTimeDisplay = 'N/A';
                 }

                 row.innerHTML = `
                    <td class="px-2 py-2 text-center font-bold">${rank}</td>
                    <td class="px-2 py-2 text-center">${categoryRank}</td>
                    <td class="px-2 py-2">${rider.number}</td>
                    <td class="px-2 py-2">${rider.name}</td>
                    <td class="px-2 py-2 font-semibold">${totalTimeDisplay}</td>
                 `;
                 currentOverallStandingsBody.appendChild(row);
            });
        };

        const startTimer = async () => {
            if (!currentRaceId || currentTimingStage === null) return showMessage('Please select a stage first.', true);
            
            const riderNumber = timingRiderInput.value;
            
            if (!riderNumber) return showMessage('Please select a rider to start.', true);
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';
            const timerDocId = `${riderNumber}-${currentTimingStage}`;
            const timerDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'races', currentRaceId, 'timers', timerDocId);

            const existingTimer = await getDoc(timerDocRef);
            if (existingTimer.exists()) {
                return showMessage(`Timer is already active for Rider #${riderNumber} on this stage.`, true);
            }
            
            try {
                await setDoc(timerDocRef, {
                    riderNumber: parseInt(riderNumber, 10),
                    stageIndex: currentTimingStage,
                    startTime: Date.now()
                });
                showMessage(`Timer started for Rider #${riderNumber} on Stage ${currentTimingStage + 1}`);
            } catch (error) {
                console.error("Error starting timer: ", error);
                showMessage('Failed to start timer. Please try again.', true);
            }
        };

        const showStageSelection = () => {
            timingStationSelect.innerHTML = '<option value="">Select Stage</option>';
            for (let i = 0; i < raceData.stages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Stage ${i + 1}`;
                timingStationSelect.appendChild(option);
            }
            stageSelectionContainer.classList.remove('hidden');
            timingStationActive.classList.add('hidden');
        };

        const startTimingForStage = () => {
            const selectedStage = parseInt(timingStationSelect.value, 10);
            if (isNaN(selectedStage) || selectedStage < 0) {
                showMessage('Please select a valid stage.', true);
                return;
            }
            currentTimingStage = selectedStage;
            stageSelectionContainer.classList.add('hidden');
            timingStationActive.classList.remove('hidden');
            timingStationHeader.textContent = `Live Timing for Stage ${currentTimingStage + 1}`;
            stageStandingsHeader.textContent = `Stage ${currentTimingStage + 1} Standings`;
            renderActiveTimers();
            renderRaceData(); // Will trigger re-render of stage-specific tables
        };

        const switchTimingStage = () => {
            currentTimingStage = null;
            if(stageStandingsBody) stageStandingsBody.innerHTML = '';
            if(currentOverallStandingsBody) currentOverallStandingsBody.innerHTML = '';
            showStageSelection();
        };

        const exportResultsToCsv = () => {
            if (!raceData || raceData.riders.length === 0) {
                showMessage('No results to export.', true);
                return;
            }

            const finishedRiders = [...raceData.riders]
                .filter(rider => rider.totalTime !== null && rider.status !== 'DNF')
                .sort((a, b) => a.totalTime - b.totalTime);
            
            const categories = [...new Set(raceData.riders.map(r => r.category).filter(c => c))];
            const categoryRankings = {};
            categories.forEach(cat => {
                categoryRankings[cat] = raceData.riders
                    .filter(r => r.category === cat && r.totalTime !== null && r.status !== 'DNF')
                    .sort((a, b) => a.totalTime - b.totalTime);
            });

            const incompleteRiders = raceData.riders.filter(rider => rider.totalTime === null && rider.status !== 'DNF');
            const dnfRiders = raceData.riders.filter(rider => rider.status === 'DNF');
            const allRidersRanked = [...finishedRiders, ...incompleteRiders, ...dnfRiders];

            const headers = ["Overall Rank", "Category Rank", "Rider #", "Name", "Category", "Total Time"];
            for (let i = 0; i < raceData.stages; i++) {
                headers.push(`Stage ${i + 1}`);
            }
            let csvContent = headers.join(",") + "\r\n";

            allRidersRanked.forEach((rider) => {
                let rank, totalTime, categoryRank = 'N/A';

                if (rider.status === 'DNF') {
                    rank = 'DNF';
                    totalTime = 'DNF';
                } else if (rider.totalTime !== null) {
                    rank = finishedRiders.findIndex(r => r.number === rider.number) + 1;
                    totalTime = formatTime(rider.totalTime);
                    if (rider.category && categoryRankings[rider.category]) {
                        const rankIndex = categoryRankings[rider.category].findIndex(r => r.number === rider.number);
                        if(rankIndex !== -1) categoryRank = rankIndex + 1;
                    }
                } else {
                    rank = 'N/A';
                    totalTime = 'N/A';
                }

                const name = `"${rider.name.replace(/"/g, '""')}"`;
                const category = `"${(rider.category || '').replace(/"/g, '""')}"`;
                const rowData = [rank, categoryRank, rider.number, name, category, totalTime];
                rider.times.forEach(time => {
                    rowData.push(formatTime(time));
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `race_results_${currentRaceId || 'export'}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements
            raceIdInput = document.getElementById('raceIdInput');
            loadRaceBtn = document.getElementById('loadRaceBtn');
            newRaceBtn = document.getElementById('newRaceBtn');
            raceInfoDiv = document.getElementById('raceInfo');
            raceTimerContainer = document.getElementById('raceTimerContainer');
            riderForm = document.getElementById('riderForm');
            ridersTableBody = document.getElementById('ridersTableBody');
            resultsTableBody = document.getElementById('resultsTableBody');
            riderCountDisplay = document.getElementById('riderCountDisplay');
            startTimerBtn = document.getElementById('startTimerBtn');
            timingRiderInput = document.getElementById('timingRiderInput');
            messageBox = document.getElementById('messageBox');
            activeTimersList = document.getElementById('activeTimersList');
            stageCountInput = document.getElementById('stageCountInput');
            exportCsvBtn = document.getElementById('exportCsvBtn');
            stageSelectionContainer = document.getElementById('stageSelectionContainer');
            timingStationSelect = document.getElementById('timingStationSelect');
            startTimingStationBtn = document.getElementById('startTimingStationBtn');
            timingStationActive = document.getElementById('timingStationActive');
            timingStationHeader = document.getElementById('timingStationHeader');
            switchStageBtn = document.getElementById('switchStageBtn');
            stageStandingsHeader = document.getElementById('stageStandingsHeader');
            stageStandingsBody = document.getElementById('stageStandingsBody');
            currentOverallStandingsBody = document.getElementById('currentOverallStandingsBody');
            
            stageCountInput.value = 6;
            
            // --- Firebase Initialization ---
            const manualFirebaseConfig = {
  apiKey: "AIzaSyCrKQpx3rZN2Y0Asy8HL08kv89eVQhoDck",
  authDomain: "race-timer-6b61e.firebaseapp.com",
  projectId: "race-timer-6b61e",
  storageBucket: "race-timer-6b61e.firebasestorage.app",
  messagingSenderId: "933028970429",
  appId: "1:933028970429:web:2c3a5a02c2d6682bde5cd4",
  measurementId: "G-D54Y5VYDT6"
};
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : manualFirebaseConfig;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'enduro-timer-default';

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    
                    if (auth.currentUser) {
                        userId = auth.currentUser.uid;
                        const userIdDisplay = document.getElementById('userIdDisplay');
                        const appIdDisplay = document.getElementById('appIdDisplay');
                        if (userIdDisplay) userIdDisplay.textContent = `User ID: ${auth.currentUser.isAnonymous ? '(Anon) ' : ''}${userId}`;
                        if (appIdDisplay) appIdDisplay.textContent = `App ID: ${appId}`;
                    }
                    
                    authReady = true;
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const userIdDisplay = document.getElementById('userIdDisplay');
                if(userIdDisplay) userIdDisplay.textContent = 'Firebase connection failed. Check config.';
                showMessage('Firebase connection failed. Please check your configuration details.', true);
            }
            
            // Add event listeners for UI elements
            loadRaceBtn.addEventListener('click', loadRace);
            newRaceBtn.addEventListener('click', createNewRace);
            riderForm.addEventListener('submit', addRider);
            startTimerBtn.addEventListener('click', startTimer);
            exportCsvBtn.addEventListener('click', exportResultsToCsv);
            startTimingStationBtn.addEventListener('click', startTimingForStage);
            switchStageBtn.addEventListener('click', switchTimingStage);
        });
    </script>

    <div class="container mx-auto p-4 flex flex-col items-center w-full">
        <header class="header-bg text-white w-full p-6 sm:p-8 rounded-xl text-center shadow-lg mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-2">Enduro Race Timer</h1>
            <p class="text-sm sm:text-base text-gray-200">Real-time, collaborative race timing for enduro events.</p>
        </header>

        <div class="w-full max-w-6xl p-4 sm:p-6 mb-8 bg-white rounded-xl shadow-lg border border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 text-gray-600 font-medium">
                <span id="userIdDisplay" class="mb-2 sm:mb-0 text-xs sm:text-sm">User ID: Loading...</span>
                <span id="appIdDisplay" class="text-xs sm:text-sm">App ID: Loading...</span>
            </div>
            <div id="raceInfo" class="space-y-4">
                <p class="text-center text-gray-700 font-medium text-lg">Create a new race or join an existing one.</p>
                 <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-center">
                    <label for="stageCountInput" class="text-gray-700 font-medium whitespace-nowrap">Number of Stages:</label>
                    <input type="number" id="stageCountInput" value="6" min="1" max="20"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="raceIdInput" placeholder="Enter Race ID to join (e.g., race_12345)"
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="loadRaceBtn" class="button w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-bold rounded-md shadow-md hover:bg-indigo-700">Load Race</button>
                    <button id="newRaceBtn" class="button w-full sm:w-auto px-6 py-2 bg-gray-600 text-white font-bold rounded-md shadow-md hover:bg-gray-700">New Race</button>
                </div>
            </div>
            <div id="raceTimerContainer" class="hidden">
                <p class="text-center font-bold text-xl text-gray-800 mb-4" id="currentRaceIdDisplay"></p>
                <div id="messageBox" class="opacity-0 transition-all duration-300 transform scale-95"></div>

                <div id="stageSelectionContainer" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Select Your Timing Stage</h2>
                    <div class="card flex flex-col items-center space-y-4 max-w-md mx-auto">
                        <label for="timingStationSelect" class="font-medium text-gray-700">Which stage are you timing today?</label>
                        <select id="timingStationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                        <button id="startTimingStationBtn" class="button w-full px-6 py-2 bg-indigo-600 text-white font-bold rounded-md shadow-md hover:bg-indigo-700">Start Timing This Stage</button>
                    </div>
                </div>
                
                <div id="timingStationActive" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                         <h2 id="timingStationHeader" class="text-2xl font-bold text-gray-800"></h2>
                         <button id="switchStageBtn" class="button px-4 py-2 bg-gray-500 text-white text-sm font-bold rounded-md shadow-md hover:bg-gray-600">Switch Stage</button>
                    </div>
                    <div class="card flex flex-col sm:flex-row items-center justify-between mb-8">
                        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full">
                            <select id="timingRiderInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                        </div>
                        <div class="flex w-full sm:w-auto mt-4 sm:mt-0 sm:ml-4">
                            <button id="startTimerBtn" class="button w-full px-6 py-2 bg-green-600 text-white font-bold rounded-md shadow-md hover:bg-green-700">Start</button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-4">Active Timers For This Stage</h3>
                    <div class="card p-4 mb-8">
                        <ul id="activeTimersList" class="space-y-2"></ul>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Add Riders</h2>
                        <span id="riderCountDisplay" class="text-sm text-gray-500 font-medium">Riders: 0/100</span>
                    </div>
                    <form id="riderForm" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="number" id="riderNumber" placeholder="Rider Number" required class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="riderName" placeholder="Rider Name" required class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="riderCategory" placeholder="Category (Optional)" class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="button w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-bold rounded-md shadow-md hover:bg-emerald-700">Add Rider</button>
                    </form>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                        <div>
                            <h3 id="stageStandingsHeader" class="text-xl font-bold text-gray-800 mb-4"></h3>
                            <div class="card p-0 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr>
                                                <th class="px-2 py-3 text-center">Rank</th>
                                                <th class="px-2 py-3">Rider #</th>
                                                <th class="px-2 py-3">Name</th>
                                                <th class="px-2 py-3">Stage Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stageStandingsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-gray-800 mb-4">Current Overall Standings</h3>
                             <div class="card p-0 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr>
                                                <th class="px-2 py-3 text-center">Ovr</th>
                                                <th class="px-2 py-3 text-center">Cat</th>
                                                <th class="px-2 py-3">#</th>
                                                <th class="px-2 py-3">Name</th>
                                                <th class="px-2 py-3">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="currentOverallStandingsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tablesContainer" class="w-full max-w-6xl space-y-8">
            <div class="card p-0 overflow-hidden">
                <h2 class="text-2xl font-bold text-gray-800 p-6">Rider & Stage Times</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr>
                                </tr>
                        </thead>
                        <tbody id="ridersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card p-0 overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Current Standings</h2>
                    <button id="exportCsvBtn" class="button px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-md shadow-md hover:bg-blue-700">Export to CSV</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center">Overall Rank</th>
                                <th class="px-4 py-3 text-center">Cat. Rank</th>
                                <th class="px-4 py-3">Rider #</th>
                                <th class="px-4 py-3">Name</th>
                                <th class="px-4 py-3">Category</th>
                                <th class="px-4 py-3">Total Time</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
